name: üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (Self-hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # ‚Üê –í–∞–∂–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–µ–º self-hosted runner
    
    steps:
    - name: üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥
      uses: actions/checkout@v3
    
    - name: üîÑ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
      run: |
        echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
        pkill -f "python app.py" || echo "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
        sleep 2
    
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
        cd /home/admin1/warehouse/Dashboard
        
        if [ ! -d "venv" ]; then
          echo "üì¶ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ venv..."
          python3 -m venv venv
        fi
        
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
        cd /home/admin1/warehouse/Dashboard
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ screen –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        screen -dmS dashboard bash -c '
          source venv/bin/activate
          python app.py
        '
        
        echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞..."
        sleep 5
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º..."
        if curl -s http://localhost:8055 > /dev/null; then
          echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
        else
          echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞"
          exit 1
        fi

name: üêõ –û—Ç–ª–∞–¥–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: self-hosted
    
    steps:
    - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
      uses: actions/checkout@v3
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      run: |
        echo "=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï ==="
        echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
        echo "–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: $(pwd)"
        echo "Python –≤–µ—Ä—Å–∏—è: $(python3 --version)"
        echo "–ü–∞–º—è—Ç—å:"
        free -h
        echo ""
        
        echo "=== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ï–ö–¢–ê ==="
        cd /home/admin1/warehouse/Dashboard
        echo "–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: $(pwd)"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
        ls -la
        echo ""
        
        echo "=== –ü–†–û–í–ï–†–ö–ê VENV ==="
        if [ -d "venv" ]; then
          echo "‚úÖ Venv —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          source venv/bin/activate
          echo "Python –≤ venv: $(python --version)"
          echo "Pip –≤ venv: $(pip --version)"
        else
          echo "‚ùå Venv –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        fi
        echo ""
    
    - name: üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
      run: |
        echo "=== –û–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–†–´–• –ü–†–û–¶–ï–°–°–û–í ==="
        cd /home/admin1/warehouse/Dashboard
        
        # –ò—â–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        echo "–ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ python:"
        ps aux | grep "python app.py" | grep -v grep || echo "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
        
        echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        pkill -f "python app.py" || echo "–ù–µ—á–µ–≥–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å"
        sleep 3
        echo ""
    
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
      run: |
        echo "=== –ü–†–û–í–ï–†–ö–ê –ò–ú–ü–û–†–¢–û–í ==="
        cd /home/admin1/warehouse/Dashboard
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
        cat > test_imports.py << 'EOF'
print("=== –¢–ï–°–¢ –ò–ú–ü–û–†–¢–û–í ===")

try:
    import dash
    print("‚úÖ dash:", dash.__version__)
except Exception as e:
    print("‚ùå dash:", e)

try:
    import dash_echarts
    print("‚úÖ dash_echarts")
except Exception as e:
    print("‚ùå dash_echarts:", e)

try:
    import pandas
    print("‚úÖ pandas:", pandas.__version__)
except Exception as e:
    print("‚ùå pandas:", e)

try:
    import numpy
    print("‚úÖ numpy:", numpy.__version__)
except Exception as e:
    print("‚ùå numpy:", e)

try:
    from data.clickhouse_client import ClickHouseClient
    print("‚úÖ ClickHouseClient")
except Exception as e:
    print("‚ùå ClickHouseClient:", e)

print("=== –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù ===")
EOF
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        if [ -d "venv" ]; then
          source venv/bin/activate
        fi
        python3 test_imports.py
        echo ""
    
    - name: üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –æ—Ç–ª–∞–¥–∫–æ–π
      run: |
        echo "=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==="
        cd /home/admin1/warehouse/Dashboard
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        pkill -f "python app.py" || true
        sleep 2
        
        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv –µ—Å–ª–∏ –µ—Å—Ç—å
        if [ -d "venv" ]; then
          source venv/bin/activate
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º venv"
        else
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π python"
        fi
        
        echo "–¢–µ–∫—É—â–∏–π python: $(python --version)"
        echo ""
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≤—ã–≤–æ–¥–æ–º –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º app.py —Å –æ—Ç–ª–∞–¥–∫–æ–π..."
        echo "=== –ù–ê–ß–ê–õ–û –õ–û–ì–û–í ==="
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
        python -u app.py 2>&1 | tee debug.log &
        APP_PID=$!
        
        echo "PID –ø—Ä–æ—Ü–µ—Å—Å–∞: $APP_PID"
        
        # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
        sleep 10
        
        if ps -p $APP_PID > /dev/null; then
          echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (PID: $APP_PID)"
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 8055..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
          if curl -s --max-time 5 http://localhost:8055 > /dev/null; then
            echo "üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://localhost:8055"
            echo "–û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞—Ç—å..."
          else
            echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –Ω–æ –ø–æ—Ä—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            echo "–õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            tail -20 debug.log
            kill $APP_PID 2>/dev/null
            exit 1
          fi
        else
          echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å"
          echo "–õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          cat debug.log
          exit 1
        fi
        echo ""
    
    - name: üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
      run: |
        echo "=== –ó–ê–ü–£–©–ï–ù–ù–´–ï –ü–†–û–¶–ï–°–°–´ ==="
        ps aux | grep -E "(python|app)" | grep -v grep || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ python"
        echo ""
        
        echo "=== –û–¢–ö–†–´–¢–´–ï –ü–û–†–¢–´ ==="
        netstat -tlnp | grep :8055 || echo "–ü–æ—Ä—Ç 8055 –Ω–µ —Å–ª—É—à–∞–µ—Ç"
        echo ""
        
        echo "=== –õ–û–ì–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫) ==="
        cd /home/admin1/warehouse/Dashboard
        if [ -f "debug.log" ]; then
          tail -30 debug.log
        else
          echo "–§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
